<!DOCTYPE html>
<html lang="pt-br">
    <head>
        <meta charset="UTF-8"/>
        <link rel="icon" href="imagens/favicon.ico"/>
        <title>Aprenda Python Pentest</title>
        <link rel="stylesheet" href="css/estilo.css"/>
    </head>
    <body>
        <div>
            <header>
                <h1>Aprenda Python Pentest</h1>
                <menu>
                    <li><a href="index.html">Página Inicial</a></li>
                    <li><a href="contato.html">Contato!</a></li>
                    <li><a href="tudo-sobre-python-pentest-1.html">Tudo sobre Python Pentest Parte 1!</a></li>
                    <li><a href="tudo-sobre-python-pentest-2.html">Tudo sobre Python Pentest Parte 2!</a></li>
                    <li><a href="tudo-sobre-python-pentest-3.html">Tudo sobre Python Pentest Parte 3!</a></li>
                    <li><a href="tudo-sobre-python-pentest-4.html" onclick="alert('Você já Está na Matéria desse Link!'); return false">Tudo sobre Python Pentest Parte 4!</a></li>
                    <li><a href="tudo-sobre-python-pentest-5.html">Tudo sobre Python Pentest Parte 5!</a></li>
                    <li><a href="tudo-sobre-python-pentest-6.html">Tudo sobre Python Pentest Parte 6!</a></li>
                </menu>
            </header>
           
<h2>Tudo sobre Python Pentest Parte 4</h2>

<h3>Criando um Whois</h3>

<p>O Whois permite que a gente faça consultas sobre um domínio, com informações como o dono do domínio, números de documentos e outras informações confidenciais. Podemos escanear as chamadas do Whois num sniffer como o Wireshark. Podemos também criar nosso próprio Whois com o Python.</p>

<p>PS: Não é todo servidor Whois que tem as informações sobre determinados domínios.</p>

<p>Esse site aqui, dá as informações sobre qual servidor Whois tem determinado servidor: <a href="https://www.iana.org/whois" target="_blank">https://www.iana.org/whois</a></p>

<p>Vamos supor que colocamos um domínio no servidor acima, e ele mostra que o Whois que ele está é o <q>whois.verisign-grs.com</q>. Nós abrimos o Netcat digitando <code>nc -v whois.verisign-grs.com 43</code>, e enquanto ele roda, colocamos o site que queremos (como o <q>globo.com</q>). Ele retornará o servidor Whois dele, que pode ser algo como <q>whois.1api.net</q>, aí rodamos o Netcat de novo com <code>nc -v whois.1api.net 43</code> e passar o domínio novamente. Podemos passar o próprio IANA no Netcat, também na porta 43, digitando <code>nc -v whois.iana.org 43</code>.</p>

<p>Tudo que teremos que fazer, é uma ferramenta que automatiza isso. Crie um novo arquivo Python, e coloque esse código:</p>

<pre>
<code>
import socket

dominio = str(input("Digite o domínio: "))
dominio += "\r\n"

sock = socket.socket(socket.AF_INET, socket.SOCK_STREAM)

sock.connect(("whois.iana.org", 43))
sock.send(dominio.encode())

print(sock.recv(1024).decode())
</code>
</pre>

<p>Para pegar só o domínio do Whois que ele retorna, faça assim no print:</p>

<pre>
<code>
print(sock.recv(1024).decode().split("refer:        ")[1].split("\n")[0])
</code>
</pre>

<p>Deixe o código assim, para entender como ele funciona melhor:</p>

<pre>
<code>
import socket

dominio = str(input("Digite o domínio: "))
dominio += "\r\n"

sock = socket.socket(socket.AF_INET, socket.SOCK_STREAM)

sock.connect(("whois.iana.org", 43))
sock.send(dominio.encode())

who1 = sock.recv(1024).decode().split("refer:        ")[1].split("\n")[0]

print(who1)

sock.close()
</code>
</pre>

<p>Como a gente vai ter que ficar repetindo partes do código tentando vários domínios retornados pelo Whois até achar o que tem o domínio que queremos, é melhor usarmos funções pra isso, veja como fica:</p>

<pre>
<code>
import socket

def abrirSocket(who):
    sock = socket.socket(socket.AF_INET, socket.SOCK_STREAM)
    sock.connect((who, 43))

    return sock

dominio = str(input("Digite o domínio: "))
dominio += "\r\n"

sock = abrirSocket("whois.iana.org")
sock.send(dominio.encode())

who1 = sock.recv(1024).decode().split("refer:        ")[1].split("\n")[0]

print(who1)

sock.close()

sock = abrirSocket(who1)
sock.send(dominio.encode())

who2 = sock.recv(1024).decode().split("Registrar WHOIS Server: ")[1].split("\r")[0] # Atenção, é "r", não "n"

print(who2)

sock.close()

sock = abrirSocket(who2)
sock.send(dominio.encode())

print(sock.recv(4096).decode())
</code>
</pre>

<p>O problema, é que mesmo aumentando o buffer do último print, ele pode <q>cortar</q> a informação. Poderíamos dividir em dois ou mais prints, ou usar um while dessa forma, no lugar do último print:</p>

<pre>
<code>
while True:
    data = sock.recv(1024)
    
    if data:
        print(data.decode())
    else:
        break
</code>
</pre>

<p>PS: Retire todos os prints que são usados pro debug, e deixe o último while assim:</p>

<pre>
<code>
resp = ""

while True:
    data = sock.recv(1024)

    if data:
        resp += data.decode()
    else:
        break
        
print(resp)
</code>
</pre>

<p>Código completo abaixo, com mais algunas correções:</p>

<pre>
<code>
import socket

def abrirSocket(who, site):
    sock = socket.socket(socket.AF_INET, socket.SOCK_STREAM)
    sock.connect((who, 43))
    sock.send(site.encode())

    return sock

dominio = str(input("Digite o domínio: "))
dominio += "\r\n"

sock = abrirSocket("whois.iana.org", dominio)

who1 = sock.recv(1024).decode().split("refer:        ")[1].split("\n")[0]

sock.close()

sock = abrirSocket(who1, dominio)

who2 = sock.recv(1024).decode().split("Registrar WHOIS Server: ")[1].split("\r")[0] # Atenção, é "r", não "n"

sock.close()

sock = abrirSocket(who2, dominio)

resp = ""

while True:
    data = sock.recv(1024)

    if data:
        resp += data.decode()
    else:
        break

print(resp)
</code>
</pre>

<h3>Adicionando Whois na Nossa Ferramenta</h3>

<p>No lugar do último print, vamos colocar isso pra ele salvar num arquivo:</p>

<pre>
<code>
dominio = dominio.strip()

with open(f"{dominio}.whois", "w") as arqWhois:
    arqWhois.write(resp)

print(f"Arquivo Whois {dominio}.whois criado!")
</code>
</pre>

<p>Podemos colocar em métodos numa classe, pode ser até a classe DnsScan mesmo:</p>

<pre>
<code>
def abrirSocket(self, who, site):
    sock = socket.socket(socket.AF_INET, socket.SOCK_STREAM)
    sock.connect((who, 43))
    sock.send(site.encode())

    return sock

def whois(self, dominio):
    dominio += "\r\n"

    sock = self.abrirSocket("whois.iana.org", dominio)

    who1 = sock.recv(1024).decode().split("refer:        ")[1].split("\n")[0]

    sock.close()

    sock = self.abrirSocket(who1, dominio)

    who2 = sock.recv(1024).decode().split("Registrar WHOIS Server: ")[1].split("\r")[0] # Atenção, é "r", não "n"

    sock.close()

    sock = self.abrirSocket(who2, dominio)

    resp = ""

    while True:
        data = sock.recv(1024)

        if data:
            resp += data.decode()
        else:
            break

    dominio = dominio.strip()

    with open(f"{dominio}.whois", "w") as arqWhois:
        arqWhois.write(resp)

    print(f"Arquivo Whois {dominio}.whois criado!")
</code>
</pre>

<p>E no programa principal (dnsfoda.py), fazemos assim:</p>

<pre>
<code>
from DnsScan import DnsScan
import sys

dominio = sys.argv[1]
wordlist = sys.argv[2]

dns = DnsScan()

print(f"Consultando Whois {dominio}")
dns.whois(dominio)
print(f"Consulta Whois finalizada!")

print("Iniciando bruteforce de subdomínios!")
dns.subdominios(dominio, wordlist)

print("Iniciando bruteforce de CNAME!")
dns.verifCName(dominio, wordlist)

print("Scan DNS finalizado!")
</code>
</pre>

<ul>
    <li><a href="tudo-sobre-python-pentest-3.html">Parte Anterior da Matéria!</a></li>
    <li><a href="tudo-sobre-python-pentest-5.html">Continuação da Matéria!</a></li>
</ul>

        </div>
    </body>
</html>