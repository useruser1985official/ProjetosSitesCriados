<!DOCTYPE html>
<html lang="pt-br">
    <head>
        <meta charset="UTF-8"/>
        <link rel="icon" href="imagens/favicon.ico"/>
        <title>Aprenda Python Pentest</title>
        <link rel="stylesheet" href="css/estilo.css"/>
    </head>
    <body>
        <div>
            <header>
                <h1>Aprenda Python Pentest</h1>
                <menu>
                    <li><a href="index.html">Página Inicial</a></li>
                    <li><a href="contato.html">Contato!</a></li>
                    <li><a href="tudo-sobre-python-pentest-1.html">Tudo sobre Python Pentest Parte 1!</a></li>
                    <li><a href="tudo-sobre-python-pentest-2.html">Tudo sobre Python Pentest Parte 2!</a></li>
                    <li><a href="tudo-sobre-python-pentest-3.html">Tudo sobre Python Pentest Parte 3!</a></li>
                    <li><a href="tudo-sobre-python-pentest-4.html" onclick="alert('Você já Está na Matéria desse Link!'); return false">Tudo sobre Python Pentest Parte 4!</a></li>
                    <li><a href="tudo-sobre-python-pentest-5.html">Tudo sobre Python Pentest Parte 5!</a></li>
                    <li><a href="tudo-sobre-python-pentest-6.html">Tudo sobre Python Pentest Parte 6!</a></li>
                    <li><a href="tudo-sobre-python-pentest-7.html">Tudo sobre Python Pentest Parte 7!</a></li>
                    <li><a href="tudo-sobre-python-pentest-8.html">Tudo sobre Python Pentest Parte 8!</a></li>
                    <li><a href="tudo-sobre-python-pentest-9.html">Tudo sobre Python Pentest Parte 9!</a></li>
                    <li><a href="tudo-sobre-python-pentest-10.html">Tudo sobre Python Pentest Parte 10!</a></li>
                    <li><a href="tudo-sobre-python-pentest-11.html">Tudo sobre Python Pentest Parte 11!</a></li>
                    <li><a href="tudo-sobre-python-pentest-12.html">Tudo sobre Python Pentest Parte 12!</a></li>
                    <li><a href="tudo-sobre-python-pentest-13.html">Tudo sobre Python Pentest Parte 13!</a></li>
                </menu>
            </header>
           
<h2>Tudo sobre Python Pentest Parte 4</h2>

<h3>Criando um Whois</h3>

<p>O Whois permite que a gente faça consultas sobre um domínio, com informações como o dono do domínio, números de documentos e outras informações confidenciais. Podemos escanear as chamadas do Whois num sniffer como o Wireshark. Podemos também criar nosso próprio Whois com o Python.</p>

<p>PS: Não é todo servidor Whois que tem as informações sobre determinados domínios.</p>

<p>Esse site aqui, dá as informações sobre qual servidor Whois tem determinado servidor: <a href="https://www.iana.org/whois" target="_blank">https://www.iana.org/whois</a></p>

<p>Vamos supor que colocamos um domínio no servidor acima, e ele mostra que o Whois que ele está é o <q>whois.verisign-grs.com</q>. Nós abrimos o Netcat digitando <code>nc -v whois.verisign-grs.com 43</code>, e enquanto ele roda, colocamos o site que queremos (como o <q>globo.com</q>). Ele retornará o servidor Whois dele, que pode ser algo como <q>whois.1api.net</q>, aí rodamos o Netcat de novo com <code>nc -v whois.1api.net 43</code> e passar o domínio novamente. Podemos passar o próprio IANA no Netcat, também na porta 43, digitando <code>nc -v whois.iana.org 43</code>.</p>

<p>Tudo que teremos que fazer, é uma ferramenta que automatiza isso. Crie um novo arquivo Python, e coloque esse código:</p>

<pre>
<code>
import socket

dominio = str(input("Digite o domínio: "))
dominio += "\r\n"

sock = socket.socket(socket.AF_INET, socket.SOCK_STREAM)

sock.connect(("whois.iana.org", 43))
sock.send(dominio.encode())

print(sock.recv(1024).decode())
</code>
</pre>

<p>Para pegar só o domínio do Whois que ele retorna, faça assim no print:</p>

<pre>
<code>
print(sock.recv(1024).decode().split("refer:        ")[1].split("\n")[0])
</code>
</pre>

<p>Deixe o código assim, para entender como ele funciona melhor:</p>

<pre>
<code>
import socket

dominio = str(input("Digite o domínio: "))
dominio += "\r\n"

sock = socket.socket(socket.AF_INET, socket.SOCK_STREAM)

sock.connect(("whois.iana.org", 43))
sock.send(dominio.encode())

who1 = sock.recv(1024).decode().split("refer:        ")[1].split("\n")[0]

print(who1)

sock.close()
</code>
</pre>

<p>Como a gente vai ter que ficar repetindo partes do código tentando vários domínios retornados pelo Whois até achar o que tem o domínio que queremos, é melhor usarmos funções pra isso, veja como fica:</p>

<pre>
<code>
import socket

def abrirSocket(who):
    sock = socket.socket(socket.AF_INET, socket.SOCK_STREAM)
    sock.connect((who, 43))

    return sock

dominio = str(input("Digite o domínio: "))
dominio += "\r\n"

sock = abrirSocket("whois.iana.org")
sock.send(dominio.encode())

who1 = sock.recv(1024).decode().split("refer:        ")[1].split("\n")[0]

print(who1)

sock.close()

sock = abrirSocket(who1)
sock.send(dominio.encode())

who2 = sock.recv(1024).decode().split("Registrar WHOIS Server: ")[1].split("\r")[0] # Atenção, é "r", não "n"

print(who2)

sock.close()

sock = abrirSocket(who2)
sock.send(dominio.encode())

print(sock.recv(4096).decode())
</code>
</pre>

<p>O problema, é que mesmo aumentando o buffer do último print, ele pode <q>cortar</q> a informação. Poderíamos dividir em dois ou mais prints, ou usar um while dessa forma, no lugar do último print:</p>

<pre>
<code>
while True:
    data = sock.recv(1024)
    
    if data:
        print(data.decode())
    else:
        break
</code>
</pre>

<p>PS: Retire todos os prints que são usados pro debug, e deixe o último while assim:</p>

<pre>
<code>
resp = ""

while True:
    data = sock.recv(1024)

    if data:
        resp += data.decode()
    else:
        break
        
print(resp)
</code>
</pre>

<p>Código completo abaixo, com mais algumas correções:</p>

<pre>
<code>
import socket

def abrirSocket(who, site):
    sock = socket.socket(socket.AF_INET, socket.SOCK_STREAM)
    sock.connect((who, 43))
    sock.send(site.encode())

    return sock

dominio = str(input("Digite o domínio: "))
dominio += "\r\n"

sock = abrirSocket("whois.iana.org", dominio)

who1 = sock.recv(1024).decode().split("refer:        ")[1].split("\n")[0]

sock.close()

sock = abrirSocket(who1, dominio)

who2 = sock.recv(1024).decode().split("Registrar WHOIS Server: ")[1].split("\r")[0] # Atenção, é "r", não "n"

sock.close()

sock = abrirSocket(who2, dominio)

resp = ""

while True:
    data = sock.recv(1024)

    if data:
        resp += data.decode()
    else:
        break

print(resp)
</code>
</pre>

<h3>Adicionando Whois na Nossa Ferramenta</h3>

<p>No lugar do último print, vamos colocar isso pra ele salvar num arquivo:</p>

<pre>
<code>
dominio = dominio.strip()

with open(f"{dominio}-whois.txt", "w") as arqWhois:
    arqWhois.write(resp)

print(f"Arquivo Whois {dominio}.whois criado!")
</code>
</pre>

<p>Podemos colocar em métodos numa classe, pode ser até a classe DnsScan mesmo:</p>

<pre>
<code>
def abrirSocket(self, who, site):
    sock = socket.socket(socket.AF_INET, socket.SOCK_STREAM)
    sock.connect((who, 43))
    sock.send(site.encode())

    return sock

def whois(self, dominio):
    dominio += "\r\n"

    sock = self.abrirSocket("whois.iana.org", dominio)

    who1 = sock.recv(1024).decode().split("refer:        ")[1].split("\n")[0]

    sock.close()

    sock = self.abrirSocket(who1, dominio)

    who2 = sock.recv(1024).decode().split("Registrar WHOIS Server: ")[1].split("\r")[0] # Atenção, é "r", não "n"

    sock.close()

    sock = self.abrirSocket(who2, dominio)

    resp = ""

    while True:
        data = sock.recv(1024)

        if data:
            resp += data.decode()
        else:
            break

    dominio = dominio.strip()

    with open(f"{dominio}-whois.txt", "w") as arqWhois:
        arqWhois.write(resp)

    print(f"Arquivo Whois {dominio}.whois criado!")
</code>
</pre>

<p>E no programa principal (dnsfoda.py), fazemos assim:</p>

<pre>
<code>
from DnsScan import DnsScan
import sys

dominio = sys.argv[1]
wordlist = sys.argv[2]

dns = DnsScan()

print(f"Consultando Whois {dominio}")
dns.whois(dominio)
print(f"Consulta Whois finalizada!")

print("Iniciando bruteforce de subdomínios!")
dns.subdominios(dominio, wordlist)

print("Iniciando bruteforce de CNAME!")
dns.verifCName(dominio, wordlist)

print("Scan DNS finalizado!")
</code>
</pre>

<h3>Criando Menu e Parsing de Informações</h3>

<p>Podemos fazer com que o nosso programa crie pasta automaticamente com os scans (por exemplo, ao escanear <q>globo.com</q>, ele cria a pasta com esses arquivos dentro).</p>

<p>Crie essa classe, pra começar:</p>

<pre>
<code>
import os

class Menu:
    def __init__(self): # Construtor
        if not os.path.isdir("scans"):
            os.mkdir("scans") # Cria pasta scans
</code>
</pre>

<p>E no dnsfoda.py, podemos comentar tudo e deixar apenas isso:</p>

<pre>
<code>
from Menu import Menu

men = Menu()
</code>
</pre>

<p>E caso queiramos que ele crie uma pasta com o nome do domínio dentro dessa pasta scan, podemos fazer assim:</p>

<pre>
<code>
import os

class Menu:
    def __init__(self, dominio): # Construtor
        if not os.path.isdir("scans"):
            os.mkdir("scans") # Cria pasta scans

        if not os.path.isdir(f"scans/{dominio}"):
            os.mkdir(f"scans/{dominio}")
</code>
</pre>

<p>E no dnsfoda.py:</p>

<pre>
<code>
from Menu import Menu

men = Menu("globo.com")
</code>
</pre>

<p>Daí, deixe a classe Menu assim:</p>

<pre>
<code>
class Menu:
    def __init__(self): # Construtor
        if not os.path.isdir("scans"):
            os.mkdir("scans") # Cria pasta scans
</code>
</pre>

<p>E aí, nesse caso, no dnsfoda.py apenas passamos <code>Menu()</code>, sem argumento.</p>

<p>E aí, na classe DnsScan, alteramos as linhas do with open assim, como nessa:</p>

<pre>
<code>
if not os.path.isdir(f"scans/{dominio}"): # Importe os
    os.mkdir(f"scans/{dominio}")

with open(f"scans/{dominio}/subdomains.json", "w") as arqJson:
    arqJson.write(domJson)
</code>
</pre>

<p>Daí, faça o mesmo com todas as ocorrências do tipo.</p>

<p>E no programa principal:</p>

<pre>
<code>
from DnsScan import DnsScan
import sys
from Menu import Menu

men = Menu()
dns = DnsScan()

dominio = sys.argv[1]
wordlist = sys.argv[2]

print(f"Consultando Whois {dominio}")
dns.whois(dominio)
print(f"Consulta Whois finalizada!")

print("Iniciando bruteforce de subdomínios!")
dns.subdominios(dominio, wordlist)

print("Iniciando bruteforce de CNAME!")
dns.verifCName(dominio, wordlist)

print("Scan DNS finalizado!")
</code>
</pre>

<p>Na classe Menu, coloque esse método, para listar os diretórios:</p>

<pre>
<code>
def exibirMenu(self):
    print(os.listdir("scans"))
</code>
</pre>

<p>E no dnsfoda.py, chame ele assim (comente o restante do código, exceto as importações, por enquanto):</p>

<pre>
<code>
men = Menu()
men.exibirMenu()
</code>
</pre>

<p>Agora descomente tudo pra criar tudo que precisamos.</p>

<p>Deixe a função exibirMenu assim:</p>

<pre>
<code>
def exibirMenu(self):
    scans = os.listdir("scans")
    id = 0

    for s in scans:
        print(f"{id} - {s}")
        id += 1

    sel = int(input("Selecione o ID: "))
    pasta = scans[sel]

    print(pasta)
</code>
</pre>

<p>E depois, deixe ela assim pra completar o código por ora:</p>

<pre>
<code>
def exibirMenu(self):
    scans = os.listdir("scans")
    id = 0

    for s in scans:
        print(f"{id} - {s}")
        id += 1

    sel = int(input("Selecione o ID: "))
    pasta = scans[sel]

    with open(f"scans/{pasta}/cname.json") as arqCname:
        cName = arqCname.read()

    print(cName)
</code>
</pre>

<p>Mude as últimas linhas para isso:</p>

<pre>
<code>
with open(f"scans/{pasta}/cname.json") as arqCname:
    cName = json.loads(arqCname.read()) # Importe json

for c in cName:
    print(f"{c} alias para {cName[c]}")
</code>
</pre>

<p>E depois pra isso, pra abrir todos os arquivos:</p>

<pre>
<code>
with open(f"scans/{pasta}/cname.json") as arqCname:
    cName = json.loads(arqCname.read())

with open(f"scans/{pasta}/subdomains.json") as arqSubs:
    subdom = json.loads(arqSubs.read())
    subIPv4 = subdom["ipv4"]
    subIPv6 = subdom["ipv6"]
    
with open(f"scans/{pasta}/whois.txt") as arqWhois:
    whois = arqWhois.read()
</code>
</pre>

<p>Daí, dentro da função, fora dos with open, podemos, por exemplo, exibir a quantidade de domínios IPv4 e IPv6, assim:</p>

<pre>
<code>
print(f"Subdomínios IPv4: {len(subIPv4)}")
print(f"Subdomínios IPv6: {len(subIPv6)}")
</code>
</pre>

<p>E depois completamos tudo assim, no lugar desses dois prints:</p>

<pre>
<code>
print(f"Subdomínios IPv4: {len(subIPv4)}")
print(f"Subdomínios IPv6: {len(subIPv6)}")
print(f"CNames: {len(cName)}")
print("Escolha IPv4, IPv6, CName, Whois ou Sair!")

while True:
    sel = str(input("Digite qual você quer exibir: "))

    if sel.lower() == "ipv4":
        for s in subIPv4:
            print(f"{s} -> {subIPv4[s]}")
    elif sel.lower() == "ipv6":
        for s in subIPv6:
            print(f"{s} -> {subIPv6[s]}")
    elif sel.lower() == "cname":
        for c in cName:
            print(f"{c} -> {cName[c]}")
    elif sel.lower() == "whois":
        print(whois)
    elif sel.lower() == "sair":
        break
    else:
        print("Comando não encontrado! Escolha IPv4, IPv6, CName, Whois ou Sair!")
</code>
</pre>

<p>E pra finalizar, deixe o dnsfoda.py assim:</p>

<pre>
<code>
from DnsScan import DnsScan
import sys
from Menu import Menu

men = Menu()
dns = DnsScan()

if len(sys.argv) == 1:
    men.exibirMenu()
    exit()

dominio = sys.argv[1]
wordlist = sys.argv[2]

print(f"Consultando Whois {dominio}")
dns.whois(dominio)
print(f"Consulta Whois finalizada!")

print("Iniciando bruteforce de subdomínios!")
dns.subdominios(dominio, wordlist)

print("Iniciando bruteforce de CNAME!")
dns.verifCName(dominio, wordlist)

print("Scan DNS finalizado!")
</code>
</pre>

<ul>
    <li><a href="tudo-sobre-python-pentest-3.html">Parte Anterior da Matéria!</a></li>
    <li><a href="tudo-sobre-python-pentest-5.html">Continuação da Matéria!</a></li>
</ul>

        </div>
    </body>
</html>