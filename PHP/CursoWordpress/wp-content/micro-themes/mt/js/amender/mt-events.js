import VisibilityObserver from"./mt-visibility-observer.js";import ApplyMod from"./mt-apply-mod.js";class TvrEventManager{constructor(e){this.amender=window.amender||{},this.isEditing=this.amender.isEditing,this.eventData=this.amender.mods,this.ensureModsIsArray(),this.amender.noAmends||(this.amender.debugAmends&&this.getServerSideTime(),this.selectorCache={},this.uniqueSelectors={},this.visibilityObserver=new VisibilityObserver({},this.uniqueSelectors,this),this.applyMod=new ApplyMod(this),this.attachedListeners=new WeakMap,addEventListener("DOMContentLoaded",(e=>{this.applyEventListeners()})))}getMTReferences(){let e=!!window.getMTWindow&&window.getMTWindow(),t=!!e&&e.TvrMT;return{MTWindow:e,TvrMT:t,TvrUi:!!t&&t.TvrUi}}async getServerSideTime(){const e=document.getElementById("server-html-timing"),t=document.getElementById("server-total-timing");if(!e||parseInt(e.dataset.zeroMods)||!t)return;const s=new URL(window.location.href);["no_amends","dyn_amends","debug_amends"].forEach((e=>s.searchParams.delete(e))),s.searchParams.set("time_amends",1);const n=await fetch(s);let i;if(i=n.ok?await n.json():{error:1},!i.error){e.innerHTML=`${i.server_html_timing} <span class="amender-unit">ms</span>`,e.setAttribute("data-time",i.server_html_timing);const s=parseFloat(document.getElementById("server-asset-timing").getAttribute("data-time"))+parseFloat(i.server_html_timing);t.innerHTML=`<strong>${s.toFixed(4)} <span class="amender-unit">ms</span></strong>`}}getNamespacedEventType(e){return e}getElementListeners(e){return this.attachedListeners.has(e)||this.attachedListeners.set(e,new Set),this.attachedListeners.get(e)}isValidSelector(e){if(!e)return!1;if(this.selectorCache.hasOwnProperty(e))return this.selectorCache[e];const t=e.split(",").map((e=>e.trim())).every((e=>CSS.supports("selector("+e+")")));return this.selectorCache[e]=t,t}collectUniqueSelectors(e){this.uniqueSelectors[e]=new Set,Object.keys(this.eventData[e]).forEach((t=>{Object.keys(this.eventData[e][t]).forEach((s=>{const n=this.eventData[e][t][s].selectorCode;this.eventData[e][t][s].mods.forEach((t=>{const s=t.mod.selector||n;this.isValidSelector(s)&&this.uniqueSelectors[e].add(s)}))}))}))}attachUniqueLister(e,t,s,n){const i=this.getNamespacedEventType(t),r=this.getElementListeners(e);r.has(i)||(n?this.visibilityObserver.observeElementForInView(e,(t=>{t&&s({target:e})})):e.addEventListener(i,(e=>{s(e)})),r.add(i))}applyEventListeners(e){this.getOrderedEventKeys(this.eventData).forEach((t=>{this.isDomEvent(t)?this.respondToEvent(t,document.documentElement,{isDomEvent:1},e):"inview"===t?(this.collectUniqueSelectors(t),this.setupInViewEvent(t,e)):["mouseenter","mouseleave","focus","blur","load","scroll","error","abort","reset","submit","selectionchange"].includes(t)?(this.collectUniqueSelectors(t),this.setupNonBubblingEvent(t,e)):this.setupBubblingEvent(t,e)})),this.initialModsDone=!0}setupBubblingEvent(e,t){this.attachUniqueLister(document.documentElement,e,(s=>this.respondToEvent(e,document.documentElement,s,t)))}getNonBubblingElements(e){const t=Array.from(this.uniqueSelectors[e]).join(", ");if(t)return document.querySelectorAll(t)}setupNonBubblingEvent(e,t){const s=this.getNonBubblingElements(e);s&&s.forEach((s=>{this.attachUniqueLister(s,e,(n=>this.respondToEvent(e,s,n,t)))}))}setupInViewEvent(e,t){const s=this.getNonBubblingElements(e);s&&s.forEach((s=>{this.attachUniqueLister(s,e,(n=>this.respondToEvent(e,s,n,t)),!0)}))}getOrderedEventKeys(e,t){const s=Object.keys(e),n=[];return["serverHTMLReady","DOMContentLoaded","load","inview_once","inview","mouseenter","mouseover","mousemove","mousedown","click","mouseup","mouseleave","mouseout","focus","input","select","change","blur","keydown","keypress","keyup","submit","reset","beforeunload","unload"].forEach((e=>{const t=s.indexOf(e);-1!==t&&(n.push(e),s.splice(t,1))})),n.push(...s),t&&n.reverse(),n}isDomEvent(e){return"DOMContentLoaded"===e||"serverHTMLReady"===e}beforeEvent(e,t,s){}afterEvent(e,t,s){}respondToEvent(e,t,s,n){let i=this.isDomEvent(e);this.beforeEvent(e,t,s),this.iterateEventData(e,"forwards",((t,r,o,a,d)=>{if(!(a.meta.finished||n&&"same"===n[t])&&this.isValidSelector(d))if(i){let t=document.querySelectorAll(d);t&&t.forEach(((t,s)=>{this.applyMod.execute(a,t,{isDomEvent:1},e)}))}else{let t=s.target;t.matches(d)&&(this.applyMod.execute(a,t,s,e),a.meta?.once&&(a.meta.finished=!0))}})),this.afterEvent(e,t,s)}iterateEventData(e,t,s,n){if(!this.eventData[e])return;let i=Object.keys(this.eventData[e]);"reverse"===t&&(i=i.reverse()),i.forEach((i=>{if(this.isMediaMatch(i)||n){let r=Object.keys(this.eventData[e][i]);"reverse"===t&&(r=r.reverse()),r.forEach((r=>{const o=this.eventData[e][i][r].selectorCode;let a=this.eventData[e][i][r].mods;if(n&&a&&"object"==typeof a&&!Array.isArray(a)){const t=[];Object.entries(a).forEach((([e,s])=>{t[parseInt(e)]=s})),a=t,this.eventData[e][i][r].mods=t}if(s){let n=Object.keys(a);"reverse"===t&&(n=n.reverse()),n.forEach((t=>{const n=a[t],d=[e,i,r,"mods",t].join("|");s(d,i,r,n,n.mod.selector||o)}))}}))}}))}ensureModsIsArray(){this.modsTypeFixDone||(this.getOrderedEventKeys(this.eventData,!0).forEach((e=>{this.iterateEventData(e,"forward",null,!0)})),this.modsTypeFixDone=!0)}updateModKeys(e,t,s,n=null){let i,r,o=!1,a={};"section"===s?(i="^"+e+"-",r=t+"-"):(i="^"+e+"$",r=t);let d=new RegExp(i);this.getOrderedEventKeys(this.eventData,!0).forEach((e=>{this.iterateEventData(e,"forwards",((t,s,n,i,c)=>{n.match(d)&&(n=n.replace(d,r),o=!0),a[e]||(a[e]={}),a[e][s]||(a[e][s]={}),a[e][s][n]||(a[e][s][n]={selectorCode:c,mods:[]});const h=parseInt(t.split("|").pop());a[e][s][n].mods[h]=i}))})),this.updateModReferences(a)}updateMods(e){let t={};this.getOrderedEventKeys(this.eventData,!0).forEach((s=>{this.iterateEventData(s,"reverse",((n,i,r,o,a)=>{if("same"!==(e.comparison[n]||"removed")){Object.keys(o.undo).reverse().forEach((e=>{this.applyMod.undo(o.undo[e],s),"inview"===s&&this.isValidSelector(a)&&(t[a]=1)}));let n=o.mod?.aspect;"js"!==n&&"jsFunction"!==n||(e.requiresPageRefresh=1)}}))}));let s=Object.keys(t);if(s.length){let e=document.querySelectorAll(s.join(", "));e&&e.forEach((e=>{this.visibilityObserver.unobserveElement(e)}))}this.amender.snippets=e.snippets,this.updateModReferences(e.mods),this.applyEventListeners(e.comparison)}updateModReferences(e){window.amender.mods=e,this.eventData=window.amender.mods}isMediaMatch(e){if("all-devices"===e)return!0;let t=e.replace("@media","");return window.matchMedia(t).matches}}window.TvrEventManagerInstance=new TvrEventManager(window.amender.mods);