import ElementDataHandler from"./mt-data-handler.js";export default class ApplyMod{constructor(e){this.amender=window.amender||{},this.timers={},this.isEditing=this.amender.isEditing,this.TvrEventManager=e,this.elementData=new ElementDataHandler(this.isEditing)}getSnippetData(e){return this.elementData.get(e)}useCodeEditor(e,t,i){return["html","innerHTML","css","js","jsFunction"].includes(t)}isUndoAble(e){return this.isEditing||e.toggle}addUndo(e,t,i){t.noUndo||t.isUndo||!this.isUndoAble(t)||(i.elements=Array.isArray(e)?e:[e],t.mod?.snippet_id&&(i.snippet_id=t.mod.snippet_id),t.undo.push(i))}undo(e,t){(Array.isArray(e)?e:[e]).forEach((e=>{e.snippet_id&&this.elementData.clear(e.elements,e.snippet_id),e.elements.forEach((i=>{this.execute({isUndo:1,mod:e},i,{},t)}))}))}createFragment(e){return document.createRange().createContextualFragment(e)}getElementIndex(e,t,i){return this.TvrEventManager.isValidSelector(t)&&(i=i||document.querySelectorAll(t)).indexOf(e)||0}execute(e,t,i,r){let n,s=e.mod,a=s.action?s.action.trim():"";const l=s.aspect?s.aspect.trim():"html",o=s.text||"",d=s.snippet_id?s.snippet_id.trim():"",c=s.find||"";let p="text"===l;n=s.liveEl?s.liveEl:!s.forceText&&d&&this.amender.snippets?this.amender.snippets[d]||"":o;const h=""===n||null===n,m="replace"===a&&h&&!e.isUndo,u=!(e.isUndo||s.enable||"remove"!==a&&"lazyLoad"!==a);if(!(!a||m||u||"replaceSubstring"===a&&""===c))try{if("html"===l||"innerHTML"===l||"text"===l)switch(a){case"prepend":case"append":case"add":case"insertBefore":case"insertAfter":h||this.insert(a,l,t,n,p,e);break;case"replace":case"replaceSubstring":this.replace(a,l,t,n,p,e,c);break;case"lazyLoad":this.lazyLoad(s,a,l,t,p,e);break;case"move":this.move(a,l,t,p,e);break;case"remove":this.remove(a,l,t,p,e)}else if("childWrapper"===l||"parentWrapper"===l){let i="parentWrapper"===l;switch(a){case"add":case"prepend":case"append":(s.tag||s.liveEl)&&this.addWrapper(e,l,t,s.tag,n,i);break;case"remove":this.removeWrapper(e,l,t,i)}}else if(this.isAttribute(l)){let i=this.getAllAttributes(t);if("attributesString"===l)switch(a){case"add":case"prepend":case"append":case"insertBefore":case"insertAfter":case"replace":this.applyAttributesFromString(t,n);break;case"remove":this.removeAllAttributes(t);break;case"replaceSubstring":n=this.substringReplace(i,c,n),this.removeAllAttributes(t),this.applyAttributesFromString(t,n)}else{const i=l;switch("class"===i||"style"===i?"add"===a&&(a="append"):"add"===a&&(a="replace"),a){case"prepend":case"append":case"insertBefore":case"insertAfter":h||this.insertAttribute(a,i,t,n,e);break;case"replace":case"replaceSubstring":"replaceSubstring"===a&&(n=this.substringReplace(t.getAttribute(i),c,n)),t.setAttribute(i,n);break;case"remove":t.removeAttribute(i)}}this.addUndo(t,e,[{elements:[t],action:"remove",aspect:"attributesString"},{elements:[t],action:"add",aspect:"attributesString",text:i,forceText:1}]),this.elementData.attach(t,e.mod.snippet_id,e.isUndo)}else if("jsFunction"===l){if("serverHTMLReady"===r||!0===this.TvrEventManager.initialModsDone&&i.isDomEvent)return;if("run"===a){const r=this.amender.funcNameMap[d]||"";if(r&&window.AF&&window.AF[r])if(s.meta?.delay){let n=s.meta.delay;this.timers[r]||(this.timers[r]=setTimeout((()=>{this.executeSafely(r,t,i,e),delete this.timers[r]}),n))}else this.executeSafely(r,t,i,e)}}}catch(e){console.warn("Failed to execute Amender change",e)}}executeSafely(e,t,i,r){try{window.AF[e].apply(window.AF,[t,i]),this.elementData.attach(t,r.mod.snippet_id,r.isUndo)}catch(t){this.logUserError(t,e)}}logUserError(e,t){console.warn(`User function error: window.AF.${t}().`,e);const{TvrUi:i}=this.TvrEventManager.getMTReferences();if(i){const r=i.extractErrorDetails(e,t);let n=`Error in your function "${r.functionName}": ${r.message}`;i.process_error("front",n,r.url,r.line,r.col)}}beforeExecute(e){}afterExecute(e){}htmlTagPattern(e){let t=e.tag,i=e.only?"^\\s*":"",r=e.only?"\\s*$":"",n=e.capParts?"(":"",s=e.capParts?")":"";return i+n+"<\\s*("+t+")[^>]*>"+s+n+"(?:[\\s\\S]*?)"+s+n+"<\\s*\\/\\s*(?:\\"+e.closeTagCap+")>"+s+r}htmlTagRegex(e){return/^\s*(<\s*([a-zA-Z0-9]+)[^>]*>(?:([\s\S]*?)<\s*\/\s*\2\s*>|\s*)?)\s*$/}isPureTag(e){return e.match(/^\s*</)&&e.match(/>\s*$/)}maybeWrapWithTag(e,t){let i=e.match(this.htmlTagRegex());if(!(!i||!this.isPureTag(e)))return e;let r=!i||["span","a","strong","em","img","br","i","b","u","small","mark","q","cite","code","kbd","var","abbr","time","sub","sup","button","label","input","textarea","select","option"].includes(i[2])?"span":"div";return t.wrapper=1,"<"+r+">"+e+"</"+r+">"}isDomEntity(e){return e instanceof DocumentFragment||e instanceof Element||e instanceof NodeList||e instanceof HTMLCollection}isValidHtmlFragment(e){if("string"!=typeof e||""===e.trim())return!0;try{const t=document.createRange();return t.createContextualFragment(e).childNodes.length>0}catch(e){return!1}}insert(e,t,i,r,n,s){if(!i)return;let a,l=[],o={};if(s.mod.liveEl||this.isDomEntity(r))a=this.maybeUnwrapArtificial(r);else{if(!this.isValidHtmlFragment(r))return;r=this.maybeWrapWithTag(r,o),a=this.createFragment(r),o.wrapper&&a.firstElementChild&&(a.firstElementChild.isArtificialWrapper=!0)}const d=i.firstChild,c=i.lastChild,p=i.previousSibling,h=i.nextSibling;switch(e){case"prepend":i.prepend(a);let e=i.firstChild;for(;e&&e!==d;)l.push(e),e=e.nextSibling;break;case"append":case"add":i.appendChild(a);let t=c?c.nextSibling:i.firstChild;for(;t;)l.push(t),t=t.nextSibling;break;case"insertBefore":i.parentNode.insertBefore(a,i);let r=p?p.nextSibling:i.parentNode.firstChild;for(;r&&r!==i;)l.push(r),r=r.nextSibling;break;case"insertAfter":h?i.parentNode.insertBefore(a,h):i.parentNode.appendChild(a);let n=i.nextSibling;for(;n&&n!==h;)l.push(n),n=n.nextSibling}this.elementData.attach(i,s.mod.snippet_id,s.isUndo),this.elementData.attach(l,s.mod.snippet_id,s.isUndo),this.addUndo(l,s,{action:"remove",aspect:"html"})}insertAttribute(e,t,i,r,n){let s=i.getAttribute(t),a=i.getAttribute(t)||"",l="class"===t?" ":"";""!==r&&("prepend"===e||"insertBefore"===e?this.prependAttribute(i,t,r,a,l):this.appendAttribute(i,t,r,a,l),this.addUndo(i,n,{action:"replace",aspect:t,text:s,forceText:1}))}prependAttribute(e,t,i,r,n){e.setAttribute(t,i+n+r)}appendAttribute(e,t,i,r,n){e.setAttribute(t,r+n+i)}maybeUnwrapArtificial(e){if(!this.isDomEntity(e))return e;const t=document.createDocumentFragment(),i=(e,t)=>{e.nodeType===Node.DOCUMENT_FRAGMENT_NODE||e.nodeType===Node.ELEMENT_NODE&&e.isArtificialWrapper?Array.from(e.childNodes).forEach((e=>i(e,t))):(t.appendChild(e),Array.from(e.childNodes).forEach((e=>{e.nodeType===Node.ELEMENT_NODE&&e.isArtificialWrapper&&e.replaceWith(...Array.from(e.childNodes))})))};return e instanceof NodeList||e instanceof HTMLCollection?Array.from(e).forEach((e=>i(e,t))):i(e,t),t}replace(e,t,i,r,n,s,a){let l="innerHTML"===t||n,o=l?"innerHTML":"outerHTML",d=i[o];if("replaceSubstring"===e&&a&&(r=this.substringReplace(d,a,r)),this.isUndoAble(s))if(l){if(this.addUndo(i,s,{action:"replace",aspect:"innerHTML",liveEl:this.detach(i,!0)}),this.isDomEntity(r)?(i.innerHTML="",i.appendChild(this.maybeUnwrapArtificial(r))):i.innerHTML=r,i.children)for(const e of i.children)this.elementData.attach(e,s.mod.snippet_id,s.isUndo)}else{const e=i.parentNode,n=i.nextElementSibling;let a=this.detach(i);if(n)this.insert("insertBefore","html",n,r,null,{noUndo:1,mod:{snippet_id:s.mod.snippet_id}}),i=n.previousSibling;else{if(!e)return;this.insert("append","html",e,r,null,{noUndo:1,mod:{snippet_id:s.mod.snippet_id}}),i=e.lastChild}i.isConnected&&this.elementData.attach(i,s.mod.snippet_id,s.isUndo),this.addUndo(i,s,{action:"replace",aspect:t,liveEl:a})}else i[o]=r}substringReplace(e,t,i){let r;if("string"==typeof t&&t.startsWith("/")){const e=t.match(/^\/(.*)\/([a-z]*)$/);e&&(r=new RegExp(e[1],e[2]))}else r=t instanceof RegExp?t:new RegExp(t,"g");return e.replace(r,i)}lazyLoad(e,t,i,r,n,s){if(r&&e.lazy_id&&"html"===i){let n=this.isEditing?"[content will <b>lazyLoad</b> and be <b>publicly accessible</b>]":"",a='<div class="lazy-placeholder" data-lazy-id="'+e.lazy_id+'">'+n+"</div>";this.replace(t,i,r,a,!1,s)}}resolveDestEl(e,t){let i=t.move_to_selector||"",r=this.TvrEventManager.isValidSelector(i),n=t.move_relative_dom?JSON.parse(t.move_relative_dom):{iterate:[]},s=this;return t.destLiveEl?t.destLiveEl:n.iterate&&n.iterate.length?(n.iterate.forEach((function(t){let r=t.selector||i;switch(t.directive){case"parent":e=e.parentElement;break;case"parents":e=s.getParents(e,r);break;case"closest":e=e.closest(r);break;case"children":e=Array.from(e.children).filter((e=>e.matches(r)));break;case"find":e=e.querySelectorAll(t.selector);break;case"next":e=e.nextElementSibling&&e.nextElementSibling.matches(r)?e.nextElementSibling:null;break;case"prev":e=e.previousElementSibling&&e.previousElementSibling.matches(r)?e.previousElementSibling:null;break;case"siblings":e=s.getSiblings(e).filter((e=>e.matches(r)))}})),NodeList.prototype.isPrototypeOf(e)||Array.isArray(e)?e.length>0?e[0]:null:e):r?document.querySelector(i):null}getParents(e,t){const i=[];let r=e.parentElement;for(;r&&r!==document;)r.matches(t)&&i.push(r),r=r.parentElement;return i}getSiblings(e){return Array.from(e.parentElement.children).filter((t=>t!==e))}move(e,t,i,r,n){let s=n.mod,a=this.resolveDestEl(i,s),l=s.move_action||"append",o=n.mod.snippet_id;if(n.move=1,a&&a.tagName){let s={undo:[],mod:{snippet_id:o,action:l,aspect:t,liveEl:this.remove(e,t,i,r,n)}};this.execute(s,a,{}),this.elementData.attach(a,o,n.isUndo),n.undo="text"===t||"innerHTML"===t?[{action:"move",aspect:"innerHTML",elements:s.undo[0].elements,destLiveEl:i}]:n.undo.concat(s.undo)}return a}remove(e,t,i,r,n){let s;if(i){let e="innerHTML"===t||r,a=this.isUndoAble(n);if(a||n.move){let r,l;e?(r="prepend",l=i,s=this.detach(i,!0)):(i.nextSibling?(r="insertBefore",l=i.nextSibling):(r="append",l=i.parentNode),s=this.detach(i)),a&&this.addUndo(l,n,{action:r,aspect:t,liveEl:s})}else e?i.innerHTML="":i.remove()}return s}detach(e,t=!1){if(!e.parentElement)return e;if(t){const t=document.createDocumentFragment();for(;e.firstChild;){let i=e.firstChild;if(i.nodeType===Node.TEXT_NODE&&""!==i.textContent.trim()){const e=document.createElement("span");e.appendChild(i),e.isArtificialWrapper=!0,t.appendChild(e)}else t.appendChild(i)}return t}return e.parentElement.removeChild(e)}addWrapper(e,t,i,r,n,s){let a;if(e.mod.liveEl?(a=e.mod.liveEl,n=""):a=document.createElement(r),this.elementData.attach(i,e.mod.snippet_id,e.isUndo),this.elementData.attach(a,e.mod.snippet_id,e.isUndo),n&&this.applyAttributesFromString(a,n),s)i.parentNode.insertBefore(a,i),Array.isArray(e.mod.siblings)?e.mod.siblings.forEach((e=>a.appendChild(e))):a.appendChild(i),this.addUndo(i,e,{action:"remove",aspect:t});else{for(;i.firstChild;)a.appendChild(i.firstChild);i.appendChild(a),this.addUndo(i,e,{action:"remove",aspect:t})}}removeWrapper(e,t,i,r){let n,s,a;if(r){if(n=i&&i.parentNode,n&&n.parentNode){const e=n.parentNode;for(a=Array.from(n.childNodes);n.firstChild;)e.insertBefore(n.firstChild,n);s=!0}}else if(n=i&&i.firstElementChild,n){for(;n.firstChild;)i.insertBefore(n.firstChild,n);s=!0}s&&n&&(this.isUndoAble(e)?this.addUndo(i,e,{action:"add",aspect:t,liveEl:this.detach(n),siblings:a}):n.remove&&n.remove())}removeWrapperAI(e,t,i,r){let n,s;if(r&&(n=i&&i.parentNode,n&&n.parentNode)){const r=n.parentNode,a=Array.from(n.childNodes);for(;n.firstChild;)r.insertBefore(n.firstChild,n);if(s=!0,s){const r=this.detach(n);this.isUndoAble(e)?this.addUndo(i,e,{action:"add",aspect:t,liveEl:r,siblings:a}):r&&r.remove&&r.remove()}}else{if(n=i&&i.firstElementChild,n){for(;n.firstChild;)i.insertBefore(n.firstChild,n);s=!0}s&&(this.isUndoAble(e)?this.addUndo(i,e,{action:"add",aspect:t,liveEl:this.detach(n)}):n&&n.remove&&n.remove())}}isAttribute(e){return new Set(["attributesString","class","id","title","alt","contenteditable","hidden","href","rel","src","srcset","sizes","style","target","width","height","required","selected","autocomplete","checked","for","type","name","value","onblur","onchange","onclick","onfocus","oninput","onload","onmouseover","onmouseout","onmousemove","onselect","role"]).has(e)||/^(?:data|x|hx|ng|v|aria)-[^\s"'<>\/=]+$/.test(e)}getAllAttributes(e){return Array.from(e.attributes).map((e=>`${e.name}="${e.value}"`)).join(" ")}removeAllAttributes(e){if(e&&e.attributes)for(;e.attributes.length>0;)e.removeAttribute(e.attributes[0].name);return""}applyAttributesFromString(e,t){const i=document.createElement("div");i.innerHTML=`<div ${t}></div>`;const r=i.firstElementChild.attributes;if(r)for(let t=0;t<r.length;t++){const i=r[t],n=i.name;n&&0!==n.indexOf("=")&&e.setAttribute(i.name,i.value)}}}